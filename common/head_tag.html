<script type="text/discourse-plugin" version="0.1">
  let words = {};
  let hasWords = false;

  if (settings.linked_words === '') {
    return;
  }

  settings.linked_words.split('|').forEach(pair => {
    if (!pair.includes(',')) {
        return;
    }
    let split = pair.split(",");
    let url = split.pop().trim();
    // We want to allow commas in regexes
    let word = split.join(",").trim();
    if (url === '' || word === '') {
        return;
    }
    words[word] = url;
    hasWords = true;
  });

  if (!hasWords) {
    return;
  }

  // roughly guided by https://stackoverflow.com/questions/8949445/javascript-bookmarklet-to-replace-text-with-a-link
  let skipTags = {
    'a': 1,
    'iframe': 1,
  };

  settings.excluded_tags.split('|').forEach(tag => {
    skipTags[tag] = 1;
  });

  let escapeRegExp = function(str) {
     return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
  }
  
  let leftWordBoundary = "(\\s|[\\([{]|^)";
  let rightWordBoundary = "([:.;,!?â€¦\\]})]|\\s|$)";
  
  let createLink = function(text, url, captured) {
    let href = url;
    for (let i = captured.length; i > 0; i--) {
      let re = new RegExp("\\$" + i.toString(), "");
      href = href.replace(re, captured[i-1]);
    }
    var link = document.createElement('a');
    link.innerHTML = text;
    link.href = href;
    link.rel = 'nofollow';
    link.target = '_blank';
    link.className = 'linkify-word no-track-link';
    return link;
  };

  let autolink = function(text) {
    // sort words longest first so regex matches first
    // (does not really makes for regex input, but does not hurt either)
    let keys = Object.keys(words).sort((x,y) => y.length - x.length);
      
    for (let i = 0; i < keys.length; i++) {
      input = keys[i];
      let url = words[input];
      let word_or_regex, modifier;
      let regex;
      // Detect regex input, should look like this: /regex/i
      let tmp = input.split("/");
      if (input[0] === "/" && tmp.length > 2) {
        modifier = tmp.pop();
        word_or_regex = tmp.slice(1).join("/");
        // Allow only "i" modifier for now, global modifier is implicit
        if (modifier === "i") {
          modifier += "g";
        } else {
          modifier = "g";
        }
      } else {
        // Input is a case-insensitive WORD
        // Autolink only first occurence of the word in paragraph,
        // i.e. do not use global modifier here
        modifier = 'i';
        word_or_regex = escapeRegExp(input);
      }
      try {
        regex = new RegExp(leftWordBoundary + "(" + word_or_regex + ")" + rightWordBoundary, modifier);
      }
      catch(err) {
        console.log("ERROR from auto-linkify theme: Invalid input:");
        console.log(word);
        console.log(err.message);
        continue;
      }

      let matches = [];
      let match = regex.exec(text.data);
      if (match === null) {
        continue;
      }
      do {
        matches.push(match);
      }
      while (modifier.includes('g') && (match = regex.exec(text.data)) !== null);

      // got to work backwards not to muck up string
      for (let i = matches.length - 1; i >= 0; i--) {
        match = matches[i];
        text.splitText(match.index + match[1].length);
        text.nextSibling.splitText(match[2].length);
        // Did we capture user defined variables?
        // By default, we capture 3 vars: left boundary, the regex itself, right boundary
        let capturedVariables = [];
        if (match.length > 4) {
          capturedVariables = match.slice(3, match.length-1);
        }
        text.parentNode.replaceChild(createLink(match[2], url, capturedVariables), text.nextSibling);
      }
    }
  }

  let linkify = function(elem) {
      // work backwards so changes do not break iteration
      for(let i = elem.childNodes.length - 1; i >=0; i--) {
        let child = elem.childNodes[i];
        if (child.nodeType === 1) {
            let tag = child.nodeName.toLowerCase();
            if (!(tag in skipTags)) {
                linkify(child);
            }
        } else if (child.nodeType === 3) {
            autolink(child);
        }
      }
  }

  api.decorateCooked($elem => {
    linkify($elem[0]);
  });
</script>
